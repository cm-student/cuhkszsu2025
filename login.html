<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>信息录入 · 学生会工作证</title>
  <style>
    :root{ --border:#111; --border2:#000; --panel:#fff; }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0; display:grid; place-items:center; min-height:100svh;
      background:url("图层 1.png") no-repeat center/cover;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "PingFang SC", "Microsoft YaHei", sans-serif;
      overflow:hidden;
    }
    .stage{ position:relative; transform:scale(var(--scale,1)); transform-origin:top center; }
    .wrap{ position:relative; }

    /* 证件卡外观，延续 main 的风格 */
    .badge{
      position:relative; z-index:1; width:360px; aspect-ratio:4/6.5; border-radius:24px;
      background: linear-gradient(to bottom, #f2e6b9 0%, #e7d8f3 45%, #c7b5ff 100%);
    }
    .badge::before{ /* 外层粗黑边 */
      content:""; position:absolute; inset:0; border-radius:24px; box-shadow:0 0 0 8px var(--border2) inset; pointer-events:none;
    }
    .badge::after{ /* 内层细黑边 */
      content:""; position:absolute; inset:14px; border-radius:18px; box-shadow:0 0 0 4px var(--border) inset; pointer-events:none;
    }

    .content{ position:relative; z-index:1; height:100%; display:flex; flex-direction:column; }

    .top{ padding:28px 28px 0; }
    .title{ text-align:center; font-size:32px; font-weight:800; letter-spacing:2px; margin:12px 0 0; }

    .panel{
      margin:18px 28px 0; background:var(--panel); border-radius:18px; box-shadow: inset 0 0 0 4px var(--border);
      padding:18px 18px 20px;
    }
    .form{ display:grid; gap:18px; }
    /* 照片上传与预览 */
    .field.file::after{ display:none; } /* 文件选择不需要下划线 */
    .field.file{ display:none; } /* 隐藏原生 choose files 按钮 */
    .preview .box{ cursor:pointer; } /* 点击预览框也可选择图片 */
    .preview{ display:flex; align-items:center; justify-content:center; gap:12px; }
    .preview .box{ width:100px; aspect-ratio:3/4; background:#fff; border-radius:12px; box-shadow: inset 0 0 0 3px var(--border); overflow:hidden; display:flex; align-items:center; justify-content:center; }
    .preview .box img{ width:100%; height:100%; object-fit:cover; display:block; }
    .preview .tip{ font-size:12px; color:#333; text-align:center; }

    /* 上传/拍照模式切换与相机预览 */
    .hidden{ display:none !important; }
    .switch{ display:flex; gap:8px; align-items:center; }
    .switch .tab{ height:28px; padding:0 10px; border-radius:999px; border:2px solid #000; background:#fff; font-size:12px; font-weight:700; cursor:pointer; }
    .switch .tab.active{ background:#111; color:#fff; }
    .preview .box video{ width:100%; height:100%; object-fit:cover; display:block; }
    .cam-ctrl{ display:flex; gap:10px; margin:6px 0 0; }
    .btn-mini{ border:2px solid #000; background:#111; color:#fff; border-radius:999px; padding:6px 10px; font-size:12px; font-weight:800; letter-spacing:1px; cursor:pointer; }
    .btn-mini:active{ transform:translateY(1px); }

    .row{ display:flex; align-items:center; gap:12px; white-space:nowrap; }
    .row strong{ flex:0 0 4em; font-size:18px; }

    .field{ flex:1; position:relative; height:34px; display:flex; align-items:flex-end; }
    .field::after{ content:""; position:absolute; left:0; right:8px; bottom:0; height:2px; background:#111; }
    .input{
      width:100%; border:none; outline:none; background:transparent;
      font-size:18px; padding:0 6px 2px; line-height:1; font-weight:600;
    }
    .input::placeholder{ color:#777; font-weight:500; }
    /* 让下拉框的“请选择”呈灰色 */
    select.input{ color:#111; }
    select.input:required:invalid{ color:#777; }
    select.input option[value=""]{ color:#777; }

    .btn-wrap{ margin:18px 28px 24px; }
    .btn{
      width:100%; height:44px; border-radius:999px; border:4px solid #000; background:#111; color:#fff;
      font-size:18px; font-weight:800; letter-spacing:2px; cursor:pointer;
    }
    .btn:active{ transform:translateY(1px); }

    /* 提示 */
    .hint{ text-align:center; font-size:12px; color:#333; margin-top:6px; }

    /* 小屏横屏微调 */
    @media (max-width:420px) and (orientation: landscape){
      .badge{ width:320px; aspect-ratio:4/5.2; }
      .row strong{ flex-basis:3.5em; font-size:16px; }
      .field{ height:30px; }
      .input{ font-size:16px; }
      .btn{ height:42px; font-size:16px; }
    }
  </style>
</head>
<body>
  <div class="stage">
    <div class="badge wrap scene">
      <div class="content">
        <div class="top">
          <div class="title">请输入个人信息</div>
        </div>
        <div class="panel">
          <form class="form" action="main.html" method="GET" autocomplete="off">
            <div class="row">
              <strong>姓名</strong>
              <div class="field"><input class="input" type="text" name="name" placeholder="（未填写）" required maxlength="12" /></div>
            </div>
            <div class="row">
              <strong>意向部门</strong>
              <div class="field">
                <select class="input" name="dept" required>
                  <option value="" disabled selected>请选择</option>
                  <option>活动部</option>
                  <option>权益部</option>
                  <option>社联部</option>
                  <option>学术部</option>
                  <option>外联部</option>
                  <option>文宣部</option>
                </select>
              </div>
            </div>
            <div class="row">
              <strong>上传照片</strong>
              <div class="field file">
                <input class="input" type="file" id="photo" name="photo" accept="image/*" />
              </div>
              <div class="switch" role="tablist" aria-label="选择方式">
                <button type="button" class="tab active" data-mode="upload">上传</button>
                <button type="button" class="tab" data-mode="camera">拍照</button>
              </div>
            </div>
            <div class="preview">
              <div class="box">
                <video id="camera" class="hidden" autoplay playsinline muted></video>
                <img id="photo-preview" alt="预览" />
              </div>
            </div>
            <canvas id="photo-canvas" class="hidden"></canvas>
            <div class="btn-wrap">
              <button class="btn" type="submit">生成工作证</button>
              <div class="hint">Powered by 学生厘米</div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <script>
    // 照片上传与预览（支持上传或相机拍照）
    (function(){
      const fileInput = document.getElementById('photo');
      const previewImg = document.getElementById('photo-preview');
      const video = document.getElementById('camera');
      const canvas = document.getElementById('photo-canvas');
      const uploadTab = document.querySelector('.switch .tab[data-mode="upload"]');
      const cameraTab = document.querySelector('.switch .tab[data-mode="camera"]');
      const fileField = document.querySelector('.field.file');
      let stream = null;
      let currentMode = 'upload';
      // 两页共享的默认头像（3:4 占位 SVG）
      window.DEFAULT_PHOTO = 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="300" height="400" viewBox="0 0 300 400"><rect width="100%" height="100%" fill="%23fff"/><rect x="10" y="10" width="280" height="380" rx="18" fill="none" stroke="%23000" stroke-width="4"/><circle cx="150" cy="140" r="60" fill="%23999"/><rect x="60" y="220" width="180" height="120" rx="24" fill="%23999"/></svg>';

      if(!fileInput || !previewImg) return;

      function stopCamera(){}
      async function startCamera(){}

      function setMode(mode){
        if(!uploadTab || !cameraTab) return;
        if(video){ video.classList.add('hidden'); }
        if(mode === 'camera'){
          uploadTab.classList.remove('active');
          cameraTab.classList.add('active');
        }else{
          uploadTab.classList.add('active');
          cameraTab.classList.remove('active');
        }
        currentMode = mode;
      }

      // 绑定模式切换
      if(uploadTab && cameraTab){
        uploadTab.addEventListener('click', ()=>{
          if(currentMode !== 'upload'){
            setMode('upload');
          }else if(fileInput){
            fileInput.removeAttribute('capture');
            fileInput.click();
          }
        });
        cameraTab.addEventListener('click', ()=>{
          // 直接调起系统相机
          if(!fileInput) return;
          fileInput.setAttribute('capture', 'environment');
          try{ fileInput.value = ''; }catch(e){}
          fileInput.click();
          // 点击后仍保持“上传”为激活态，避免出现站内相机 UI
          setMode('upload');
        });
      }
      setMode('upload');

      // 上传文件预览
      fileInput.addEventListener('change', function(){
        const file = this.files && this.files[0];
        if(!file) return;
        if(file.size > 5*1024*1024){ // 5MB 简单限制
          alert('图片大于 5MB，请重新选择');
          this.value = '';
          return;
        }
        const reader = new FileReader();
        reader.onload = () => {
          previewImg.src = reader.result;
          previewImg.style.display = 'block';
          try{ localStorage.setItem('su_photo_dataurl', reader.result); }catch(e){}
          setMode('upload');
          // 移除相机捕获属性，避免下次“上传”仍强制调用相机
          fileInput.removeAttribute('capture');
        };
        reader.readAsDataURL(file);
      });

      // 点击预览框在“上传”模式下也可选择文件
      const previewBox = document.querySelector('.preview .box');
      if(previewBox){
        previewBox.addEventListener('click', ()=>{
          if(currentMode === 'upload' && fileInput){
            fileInput.removeAttribute('capture');
            fileInput.click();
          }
        });
      }

      // 恢复缓存（或默认占位）
      try{
        const cached = localStorage.getItem('su_photo_dataurl');
        if(cached){
          previewImg.src = cached;
        }else{
          previewImg.src = window.DEFAULT_PHOTO; // 与 main.html 使用同一默认
        }
        previewImg.style.display = 'block';
      }catch(e){
        previewImg.src = window.DEFAULT_PHOTO;
        previewImg.style.display = 'block';
      }
    })();
    // 提交前：把预览里的照片写入 localStorage 供 main.html 读取
    (function(){
      const form = document.querySelector('form.form');
      const previewImg = document.getElementById('photo-preview');
      const canvas = document.getElementById('photo-canvas');
      if(!form || !previewImg || !canvas) return;
      form.addEventListener('submit', function(e){
        const src = previewImg.getAttribute('src');
        if(!src){ return; }
        // 若已是 dataURL，直接存入
        if(/^data:/i.test(src)){
          try{ localStorage.setItem('su_photo_dataurl', src); }catch(err){}
          return; // 继续提交
        }
        // 若是普通 URL，则转为 3:4 的 dataURL 再存（确保与证件照比例一致）
        e.preventDefault();
        const img = new Image();
        img.crossOrigin = 'anonymous';
        img.onload = function(){
          const targetW = 300, targetH = 400, target = targetW/targetH; // 3:4
          const vw = img.naturalWidth, vh = img.naturalHeight, vr = vw/vh;
          let sx=0, sy=0, sw=vw, sh=vh;
          if(vr > target){ sh = vh; sw = Math.floor(vh*target); sx = Math.floor((vw - sw)/2); }
          else{ sw = vw; sh = Math.floor(vw/target); sy = Math.floor((vh - sh)/2); }
          canvas.width = targetW; canvas.height = targetH;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, sx, sy, sw, sh, 0, 0, targetW, targetH);
          const data = canvas.toDataURL('image/jpeg', 0.92);
          try{ localStorage.setItem('su_photo_dataurl', data); }catch(err){}
          form.submit();
        };
        img.onerror = function(){ form.submit(); };
        img.src = src || window.DEFAULT_PHOTO;
      });
    })();
    // 等比缩放，和 main.html 保持一致：在 9:16~9:21 竖屏范围视觉大小一致
    function fitStage(){
      const stage = document.querySelector('.stage');
      const scene = document.querySelector('.scene');
      if(!stage || !scene) return;
      stage.style.setProperty('--scale', 1);
      const rect = scene.getBoundingClientRect();
      const vh = window.innerHeight;
      const rMin = 9/21; // 适配最窄竖屏
      const s = (vh / rect.height) * (rMin * rect.height / rect.width) * 0.98; // 留边距
      stage.style.setProperty('--scale', s);
    }
    window.addEventListener('load', fitStage);
    window.addEventListener('resize', fitStage, { passive:true });
  </script>
</body>
</html>